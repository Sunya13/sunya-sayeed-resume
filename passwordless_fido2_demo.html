<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAM Passwordless Desktop Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease;
        }
        .ping-gradient {
            background-image: linear-gradient(to right, #2c3e50, #2980b9);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

<div id="app" class="w-full max-w-lg">
    <!-- Header & Architectural Context Panel -->
    <div class="mb-6 p-6 rounded-xl card bg-white border border-gray-100">
        <h1 class="text-2xl font-bold text-gray-800">IAM Passwordless Architect Demo</h1>
        <p class="text-sm text-gray-500 mt-2">
            Simulating <strong>PingID FIDO2 Passkey</strong> workflow for mixed-fleet (Windows/macOS) desktop access.
        </p>
        <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-700 rounded-lg text-sm">
            <strong>Architectural Key (IDP Persistence Mimicry):</strong> The public key is securely stored in the simulated IDP directory (<span class="font-bold">localStorage</span>). We use the W3C <strong>WebAuthn API</strong> (FIDO2) to trigger the device's native platform authenticator (Windows Hello, Touch ID).
        </div>
    </div>

    <div id="main-card" class="card bg-white p-8 rounded-xl border border-gray-100">
    </div>

    <div id="notification-bar" class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 text-white text-center text-sm hidden"></div>
</div>

<script>
    const USER_DATA_KEY = 'pingIdDemoUserData';
    const mainCard = document.getElementById('main-card');
    const notificationBar = document.getElementById('notification-bar');

    // Default fictional user data
    let userData = {
        username: 'iam-architect',
        displayName: 'IAM Solution Architect',
        isRegistered: false,
        credentialId: null,
    };

    const userId = '1234567890'; // Fixed user ID for demo

    // Function to load user data from localStorage (Simulating IDP retrieval)
    function loadUserData() {
        const storedData = localStorage.getItem(USER_DATA_KEY);
        if (storedData) {
            userData = JSON.parse(storedData);
        }
    }

    // Function to save user data to localStorage (Simulating IDP storage)
    function saveUserData() {
        localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
    }

    // --- Utility Functions ---

    // Display a transient notification message
    function notify(message, isError = false) {
        notificationBar.textContent = message;
        notificationBar.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
        notificationBar.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
        notificationBar.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
        setTimeout(() => {
            notificationBar.classList.add('hidden');
        }, 5000);
    }

    // Convert base64url string to ArrayBuffer
    function base64UrlToUint8Array(base64Url) {
        let padding = '='.repeat((4 - base64Url.length % 4) % 4);
        let base64 = (base64Url + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        let raw = window.atob(base64);
        let outputArray = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; ++i) {
            outputArray[i] = raw.charCodeAt(i);
        }
        return outputArray;
    }

    // Convert ArrayBuffer to base64url string
    function uint8ArrayToBase64Url(uint8Array) {
        return btoa(String.fromCharCode.apply(null, uint8Array))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
    }

    // --- Architectural/Contingency Functions ---

    // Shows the simulated IDP state (for architectural talking point)
    function showIdpState() {
        const state = `Registered: ${userData.isRegistered}. Credential ID: ${userData.credentialId ? userData.credentialId.substring(0, 10) + '...' : 'N/A'}`;
        alert(`--- Simulated PingID Directory Record ---\nUser: ${userData.username}\n${state}\n\nThis ID (Public Key) is used to verify the device's signature.`);
    }

    // Simulates the account recovery flow (for architectural talking point)
    function initiateRecovery() {
        const message = "‚úÖ Account Recovery Initiated. \n\nArchitectural Note: In a real environment, PingID would now issue a Time-bound Temporary Access Pass (TAP) via the user's mobile device (PingID App) or a trusted secondary email, allowing the user to enroll a *new* Passkey on a replacement device.";

        // Simulates deleting the old device credential from the IDP
        userData.isRegistered = false;
        userData.credentialId = null;
        saveUserData();

        alert(message);
        renderLogin();
    }


    // --- FIDO2 (WebAuthn) API Simulation Functions ---

    /**
     * Simulates Passkey Registration (navigator.credentials.create)
     */
    async function registerPasskey() {
        try {
            // Fictional data structure PingID would provide for a credential creation challenge
            const challenge = base64UrlToUint8Array('rWzXh8-u3Q5d5lM2t7k4s0p9j1yC6oA8');

            const publicKeyCredentialCreationOptions = {
                challenge: challenge,
                rp: {
                    name: "Ping Identity Demo RP",
                    id: window.location.hostname, // Use current hostname for demo
                },
                user: {
                    id: base64UrlToUint8Array(userId),
                    name: userData.username,
                    displayName: userData.displayName,
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }], // ES256
                authenticatorSelection: {
                    authenticatorAttachment: "platform", // Use platform biometrics (WHfB, Touch ID)
                    userVerification: "required", // Forces biometric/PIN usage
                    requireResidentKey: false,
                },
                timeout: 60000,
                attestation: "direct",
            };

            const credential = await navigator.credentials.create({
                publicKey: publicKeyCredentialCreationOptions
            });

            if (credential) {
                userData.credentialId = uint8ArrayToBase64Url(new Uint8Array(credential.rawId));
                userData.isRegistered = true;
                // SIMULATED IDP ACTION: Save the public key (represented by credentialId)
                saveUserData();
                notify("‚úÖ Passkey Registered! This device is now phishing-resistant (IDP Record Created).", false);
                render(true); // Go directly to the dashboard after registration
            }
        } catch (error) {
            console.error("FIDO2 Registration Failed:", error);
            notify(`‚ùå Registration failed. Error: ${error.message}. (Authentication Failed)`, true);
            renderLogin();
        }
    }

    /**
     * Simulates Passkey Authentication (navigator.credentials.get)
     */
    async function authenticatePasskey() {
        if (!userData.isRegistered || !userData.credentialId) {
            notify("User must register a Passkey first.", true);
            renderLogin();
            return;
        }

        try {
            // Fictional data structure PingID would provide for a login assertion challenge
            const challenge = base64UrlToUint8Array('Fk-l8j1vC0u4t7k2s9p6o3yE5xA9z7Bw');
            const credentialId = base64UrlToUint8Array(userData.credentialId);

            const publicKeyCredentialRequestOptions = {
                challenge: challenge,
                allowCredentials: [{
                    type: 'public-key',
                    id: credentialId,
                    transports: ['internal']
                }],
                timeout: 60000,
                userVerification: 'required',
            };

            const assertion = await navigator.credentials.get({
                publicKey: publicKeyCredentialRequestOptions
            });

            if (assertion) {
                // SIMULATED IDP ACTION: PingID verifies the signed assertion against the stored public key.
                notify("üîí Authentication successful! Welcome (IDP Assertion Verified).", false);
                render(true); // Go to the dashboard
            }
        } catch (error) {
            console.error("FIDO2 Authentication Failed:", error);
            notify(`‚ùå Login failed. Error: ${error.message}. Please try again.`, true);
            renderLogin();
        }
    }

    // --- Rendering Functions ---

    function renderSSODashboard() {
        mainCard.innerHTML = `
            <div class="flex items-center space-x-4 mb-6 pb-4 border-b">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">PingOne SSO Dashboard</h2>
                    <p class="text-gray-600">Authenticated as: <span class="font-semibold">${userData.displayName}</span></p>
                </div>
            </div>

            <p class="text-sm font-semibold text-gray-700 mb-4">The FIDO2 credential created a high-assurance session. Access is now seamless:</p>

            <div class="grid grid-cols-2 gap-4">
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800 flex items-center mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                        SaaS Federation
                    </h3>
                    <p class="text-xs text-gray-600 mb-3">Access via SAML/OIDC Protocol</p>
                    <button class="w-full ping-gradient text-white py-2 text-sm rounded-md font-semibold hover:opacity-90 transition duration-150" disabled>
                        Launch App 1
                    </button>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800 flex items-center mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.225a2 2 0 01-1.414-.586L11 12.414l-1.354 1.353a2 2 0 01-2.828 0L6 12.414l-.775.775a2 2 0 01-1.414.586H3v-8zm2 0h10v6.586l.775.775a1 1 0 001.414 0L15 12.414V5H5v8a1 1 0 001 1h8a1 1 0 001-1v-1a1 1 0 00-1-1h-2a1 1 0 00-1 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 00-1-1H5v-1z" clip-rule="evenodd" /></svg>
                        Legacy Bridge
                    </h3>
                    <p class="text-xs text-gray-600 mb-3">Access via PingAccess Bridge/SSO Agent</p>
                    <button class="w-full bg-blue-500 text-white py-2 text-sm rounded-md font-semibold hover:bg-blue-600 transition duration-150" disabled>
                        Launch App 2
                    </button>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200 space-y-3">
                <h3 class="font-bold text-gray-800 flex items-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a9 9 0 00-9 9c0 4.14 2.827 7.625 6.64 8.79l.526-.85c-3.14-.83-5.3-3.645-5.3-6.94 0-4.418 3.582-8 8-8s8 3.582 8 8c0 3.3-2.16 6.115-5.3 6.94l.525.85C17.173 17.625 20 14.14 20 10a9 9 0 00-9-9zM9 10a1 1 0 00-1 1v2a1 1 0 002 0v-2a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    Contingency Planning
                </h3>
                <p class="text-xs text-gray-600">Architectural consideration: If the user loses their device, PingID initiates a recovery flow:</p>

                <button onclick="initiateRecovery()" class="w-full bg-orange-500 text-white py-2 rounded-lg font-semibold hover:bg-orange-600 transition duration-150 text-sm flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    <span>Simulate Device Loss / Initiate Recovery</span>
                </button>

                <button onclick="renderLogin()" class="w-full bg-gray-400 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-150 mt-4">
                    Logout
                </button>
            </div>
        `;
    }

    function renderLogin() {
        mainCard.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-800 mb-6">IAM Login Portal - Powered by PingID</h2>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" value="${userData.username}" readonly
                        class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter your username">
                    <p class="mt-1 text-xs text-gray-500">PingID identifies the user and checks for available Passkey credentials.</p>
                </div>

                ${userData.isRegistered ?
                    `
                    <div class="pt-4 border-t border-green-300">
                        <p class="text-sm font-medium text-green-600 mb-3">‚úÖ Passkey Credential Found in IDP Directory!</p>
                        <button onclick="authenticatePasskey()"
                            class="w-full ping-gradient text-white py-3 rounded-lg font-bold hover:opacity-90 transition duration-150 shadow-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2h2a2 2 0 012 2v5a2 2 0 01-2 2H3a2 2 0 01-2-2v-5a2 2 0 012-2h2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                            </svg>
                            <span>Sign In with Passkey / Biometric</span>
                        </button>
                        <p class="mt-2 text-xs text-center text-gray-500">Triggering platform authenticator (Windows Hello / Touch ID)</p>
                    </div>
                    ` :
                    `
                    <div class="pt-4 border-t border-red-300">
                        <p class="text-sm font-medium text-red-600 mb-3">‚ùå No Passkey Detected in IDP Directory. Enrollment Required.</p>
                        <button onclick="registerPasskey()"
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-150 shadow-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 2a5 5 0 00-5 5v2h2V7a3 3 0 016 0v2h2V7a5 5 0 00-5-5z" />
                                <path d="M4 11a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2v-4a2 2 0 00-2-2H4zm12 3a1 1 0 110 2 1 1 0 010-2z" />
                            </svg>
                            <span>Register New Passkey (Passwordless Enrollment)</span>
                        </button>
                        <p class="mt-2 text-xs text-center text-gray-500">Simulates one-time password/MFA challenge for key provisioning.</p>
                    </div>
                    `
                }

                <button onclick="notify('‚ùå Password login is now disabled via PingID Conditional Access Policy.', true)"
                    class="w-full bg-red-100 text-red-700 py-3 rounded-lg font-semibold border border-red-300 hover:bg-red-200 transition duration-150">
                    Traditional Password Login (DISABLED by Policy)
                </button>

                <button onclick="showIdpState()" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-medium hover:bg-gray-200 transition duration-150 text-xs">
                    View Simulated IDP State (For Architect Review)
                </button>
            </div>
        `;
    }

    // Main rendering logic based on authentication status
    function render(isAuthenticated) {
        if (isAuthenticated) {
            renderSSODashboard();
        } else {
            renderLogin();
        }
    }

    // Check for FIDO support and load data on initial page load
    window.onload = () => {
        loadUserData(); // Load persistence layer
        if (window.isSecureContext && navigator.credentials && navigator.credentials.create) {
            render(false);
        } else {
            mainCard.innerHTML = `<p class="text-red-600 font-semibold">‚ùå WebAuthn/FIDO2 API is not supported in this browser environment. Please try Chrome/Edge/Firefox on HTTPS or localhost.</p>`;
        }
    };

</script>
</body>
</html>
